@using ChessNET.Domain
@inject LegalMovesGenerator LegalMoves;

<Chessboard PiecesPositions="PiecesPositions" PieceSelected="PieceSelected" PieceDeselected="PieceDeselected" SquareClicked="SquareClicked"/>

@code {
    private Move[] legalMoves = new Move[0];
    private PiecePosition selectedPiece;
    
    [Parameter]
    public IEnumerable<PiecePosition> PiecesPositions { get; set; } = Enumerable.Empty<PiecePosition>();
    
    [Parameter]
    public Color ColorToMove { get; set; } = Color.White;

    [Parameter]
    public EventCallback<Move> PieceMoved { get; set; }

    private async Task PieceSelected(PiecePosition p)
    {
        selectedPiece = p;
        legalMoves = await LegalMoves.GetLegalMovesFromSquare(PiecesPositions, ColorToMove, p.Square);
    }

    private void PieceDeselected(PiecePosition p)
    {
        if (selectedPiece == p)
        {
            selectedPiece = null;
        }
    }

    private async Task SquareClicked(Square square)
    {
        var move = legalMoves.FirstOrDefault(m => m.To == square);
        if (move == null)
        {
            legalMoves = new Move[0];
        }
        else
        {
            await PieceMoved.InvokeAsync(move);
        }
    }
}