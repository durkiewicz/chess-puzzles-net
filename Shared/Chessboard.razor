<div class="chessboard__wrapper">
    <div class="chessboard">
        @foreach (var p in PiecesPositions)
        {
            <Piece Position=@p IsSelected=@(selectedPiecePosition == p) OnClick="PieceClicked"/>
        }
    </div>
    <div class="chessboard">
        @foreach (var rank in Enumerable.Range(1, 8).Reverse())
        {
            @foreach (var file in Enumerable.Range(1, 8).Select(n => (File) n))
            {
                <SquareComponent Square="new Square(file, rank)" OnClick=@HandleSquareClick/>
            }
        }
    </div>
</div>

@code {
    private PiecePosition selectedPiecePosition;
    
    [Parameter]
    public Color ColorToMove { get; set; } = Color.White;
    
    [Parameter]
    public IEnumerable<PiecePosition> PiecesPositions { get; set; } = Enumerable.Empty<PiecePosition>();

    [Parameter]
    public EventCallback<Square> SquareClicked { get; set; }
    
    [Parameter]
    public EventCallback<PiecePosition> PieceSelected { get; set; }
    
    [Parameter]
    public EventCallback<PiecePosition> PieceDeselected { get; set; }
    
    private async Task PieceClicked(PiecePosition piece)
    {
        if (piece.Color == ColorToMove)
        {
            selectedPiecePosition = piece;
            await PieceSelected.InvokeAsync(piece);
        }
        else
        {
            await DeselectPieceIfNeeded();
        }
    }

    private async Task HandleSquareClick(Square square)
    {
        await DeselectPieceIfNeeded();
        await SquareClicked.InvokeAsync(square);
    }

    private async Task DeselectPieceIfNeeded()
    {
        if (selectedPiecePosition == null) return;
        await PieceDeselected.InvokeAsync(selectedPiecePosition);
        selectedPiecePosition = null;
    }
}